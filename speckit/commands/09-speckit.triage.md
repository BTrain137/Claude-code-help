---
name: 09-speckit.triage
description: Triage checklist items and remediate gaps by updating spec/plan/tasks with user approval. Use after running /08-speckit.checklist to resolve identified gaps before implementation. Categorizes items as already-covered, needs-spec-update, needs-new-task, out-of-scope, or needs-clarification.
---

## Purpose

Automate the resolution of checklist items generated by `/08-speckit.checklist`. For each unchecked item, determine whether it's already covered, needs a spec/plan update, or requires new tasks—then apply approved remediations.

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

- If a specific checklist filename is provided (e.g., `review.md`), use that file
- If empty, auto-detect the most recent checklist in the `checklists/` directory

## Execution Steps

### 1. Setup

Run `.specify/scripts/bash/check-prerequisites.sh --json` from repo root and parse JSON for FEATURE_DIR and AVAILABLE_DOCS.

Derive paths:
- CHECKLISTS_DIR = FEATURE_DIR/checklists/
- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

For single quotes in args like "I'm Groot", use escape syntax: e.g 'I'\''m Groot' (or double-quote if possible: "I'm Groot").

### 2. Load Checklist

If `$ARGUMENTS` specifies a filename:
- Load `CHECKLISTS_DIR/$ARGUMENTS`

Otherwise:
- List files in CHECKLISTS_DIR
- Select the most recently modified `.md` file
- If no checklists exist, abort with: "No checklists found. Run /08-speckit.checklist first."

Parse the checklist to extract:
- All unchecked items (`- [ ] CHK###`)
- Item ID, description, and markers (`[Gap]`, `[Ambiguity]`, `[Assumption]`, etc.)

### 3. Load Feature Context

Read the following for evaluation context:
- spec.md: Requirements and scope
- plan.md: Technical decisions and architecture
- tasks.md: Implementation tasks
- data-model.md (if exists): Entity definitions
- contracts/ (if exists): API schemas

### 4. Triage Each Unchecked Item

For each unchecked checklist item, evaluate and categorize:

**Category A: Already Covered**
- The requirement IS addressed in spec/plan/tasks
- The checklist item can be marked as complete
- Provide brief evidence (e.g., "Covered in spec.md §FR-008")

**Category B: Needs Spec/Plan Update**
- A gap exists in the requirements documentation
- Propose specific text to add/modify in spec.md or plan.md
- Include exact location (section, after which line)

**Category C: Needs New Task**
- The requirement is clear but missing implementation task coverage
- Propose new task(s) to add to tasks.md
- Include task ID, phase, description, and dependencies

**Category D: Intentional Exclusion**
- The item is out of scope for this feature
- Recommend adding to "Out of Scope" section if not already there
- Or mark as "N/A" with justification

**Category E: Needs Clarification**
- Cannot determine without user input
- Flag for interactive resolution

### 5. Generate Triage Report

Output a structured report:

```markdown
## Triage Report: [checklist filename]

### Summary
- Total unchecked items: X
- Already covered (A): X
- Needs spec/plan update (B): X
- Needs new task (C): X
- Intentional exclusion (D): X
- Needs clarification (E): X

### Category A: Already Covered
| Item | Evidence | Action |
|------|----------|--------|
| CHK### | Covered in spec.md §FR-XXX | Mark complete |

### Category B: Spec/Plan Updates
| Item | Gap | Proposed Fix | Location |
|------|-----|--------------|----------|
| CHK### | Missing X | Add: "..." | spec.md after §Assumptions |

### Category C: New Tasks
| Item | Proposed Task | Phase | Dependencies |
|------|---------------|-------|--------------|
| CHK### | T0XX: Description | Phase 6 | T039 |

### Category D: Intentional Exclusions
| Item | Reason |
|------|--------|
| CHK### | Out of scope per §Out of Scope |

### Category E: Needs Clarification
| Item | Question |
|------|----------|
| CHK### | Should X be included? |
```

### 6. Interactive Resolution (Category E)

If any items need clarification:
- Present questions to user using AskUserQuestion tool
- Limit to 3 questions at a time
- Re-categorize based on answers

### 7. Propose Remediations

After triage is complete, ask user for approval mode:

**Option 1: Review All**
- Show each proposed change
- User approves/rejects individually

**Option 2: Batch by Category**
- Apply all Category A (mark complete) at once
- Apply all Category B (spec updates) with single approval
- Apply all Category C (new tasks) with single approval

**Option 3: Full Auto**
- Apply all changes without individual approval
- Show summary of what was changed

Default to **Option 2** if user doesn't specify.

### 8. Apply Approved Changes

**For Category A items:**
- Edit the checklist file to mark items complete: `- [x] CHK###`
- Add brief note: `- [x] CHK### ... ✓ Covered in §X`

**For Category B items:**
- Edit spec.md or plan.md with proposed additions
- Use Edit tool with precise old_string/new_string
- Maintain document formatting and section structure

**For Category C items:**
- Add new tasks to tasks.md in appropriate phase
- Use next available task ID (e.g., if last is T045, add T046)
- Include proper formatting: `- [ ] T0XX [Phase] Description`

**For Category D items:**
- Mark as N/A in checklist: `- [N/A] CHK### ... (Out of scope)`
- Optionally add to spec.md §Out of Scope if not already there

### 9. Update Checklist Status

After applying changes:
- Re-read the checklist
- Mark all addressed items as complete
- Add timestamp comment at top: `<!-- Last triaged: YYYY-MM-DD -->`

### 10. Report Results

Output final summary:

```markdown
## Triage Complete

**Checklist**: [filename]
**Items processed**: X of Y

### Changes Applied
- Marked complete: X items
- Spec updates: X additions
- Plan updates: X additions
- New tasks added: X (T0XX-T0YY)
- Marked N/A: X items

### Remaining
- Still unchecked: X items
- Needs follow-up: X items

### Next Steps
[Contextual recommendations]
```

## Operating Principles

### Accuracy Over Speed
- Verify each "Already Covered" claim with specific evidence
- Don't mark items covered if only partially addressed
- When uncertain, categorize as "Needs Clarification"

### Minimal Invasive Changes
- Prefer adding to existing sections over creating new ones
- Match the style and formatting of existing content
- Don't reorganize or refactor unrelated content

### Preserve Intent
- Don't change the meaning of existing requirements
- New content should complement, not contradict
- Flag potential conflicts for user review

### Traceability
- Link new tasks to checklist items that spawned them
- Reference checklist IDs in commit messages if applicable
- Maintain audit trail in checklist comments

## Examples

### Example: Category B (Spec Update)

**Checklist Item:**
```
- [ ] CHK032 - Is behavior specified when user total would become negative after deletion? [Edge Case, Gap]
```

**Triage Result:**
```
Category: B (Needs Spec Update)
Gap: No requirement addresses negative total prevention
Location: spec.md, add to §Edge Cases after line 72

Proposed Addition:
"- What happens when deletion would result in negative user total?
   The system should enforce a floor of zero; if calculated total
   would be negative (due to data inconsistency), set to zero and
   log a warning for investigation."
```

### Example: Category C (New Task)

**Checklist Item:**
```
- [ ] CHK050 - Is pagination behavior specified for chain executions? [Gap]
```

**Triage Result:**
```
Category: C (Needs New Task)
Gap: No task covers pagination for chain executions API
Phase: Phase 4 (User Story 1 - Generation Display)

Proposed Task:
- [ ] T046 [US1] Add pagination support to chain-executions API endpoint
      in `src/app/admin/api/generations/[id]/chain-executions/route.ts`
      with limit/offset params (default limit: 50)
```

## Edge Cases

- **Empty checklist**: Abort with helpful message
- **All items already checked**: Report "Nothing to triage" and exit
- **Conflicting remediations**: Flag for user and don't auto-apply
- **Large number of gaps (>20)**: Batch into priority groups, process high-impact first
